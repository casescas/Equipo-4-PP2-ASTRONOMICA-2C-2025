# Backfill de Octas ‚Äî Gu√≠a de Uso

Este documento explica c√≥mo ejecutar el **backfill de datos de octas** a partir de las im√°genes p√∫blicas del servidor meteorol√≥gico, utilizando el modelo de predicci√≥n y la base de datos local.

---

## üß© ¬øQu√© hace el backfill?

- Obtiene im√°genes de cielo en intervalos de 10 minutos.
- Clasifica la cantidad de nubes usando un **modelo de IA** (`600EPOC_modelo_octa.h5`).
- Genera un registro hist√≥rico en **SQLite**, guardando:
  - `fecha_hora_prediccion`
  - `octas_predichas`
  - `confianza`
  - `categoria` (SKC, FEW, SCT, BKN, OVC)
  - `descripcion`
  - `url_imagen`

---

## üìÅ Estructura esperada del proyecto

backend/
‚îú‚îÄ backfill.py
‚îú‚îÄ database.py
‚îú‚îÄ registros-octas.db ‚Üê se crea autom√°ticamente
‚îî‚îÄ models/
‚îî‚îÄ 600EPOC_modelo_octa.h5



# ‚öôÔ∏è Configuraci√≥n relevante en backfill.py
IMG_URL_BASE = "http://201.251.63.225/meteorologia/cielo/image/"
MODEL_PATH = "models/600EPOC_modelo_octa.h5"

# Pausa entre requests (anti-baneo)
REQUEST_SLEEP_SECONDS = 0.25
TIP:

  - 0.25 = r√°pido + estable
  -  0.5 = m√°s seguro
  -  0 = m√°ximo rendimiento, pero posible rate-limit
  
# üß† Bases del funcionamiento
Las im√°genes est√°n dentro de carpetas por a√±o:

/meteorologia/cielo/image/<A√ëO>/<YYYY>-<MMDDHH><mm>.jpg

Ejemplo real:

/meteorologia/cielo/image/2025/2025-01010002.jpg

# üöÄ C√≥mo ejecutar el Backfill

1) Rango definido
   
python backfill.py `
  --desde "2025-01-01T00:00" `
  --hasta "2025-01-31T23:59" `
  --step-min 10 `
  --modo forzar

2) √öltimos 3 d√≠as autom√°ticamente
python backfill.py `
  --desde "$( (Get-Date).AddDays(-3).ToString('yyyy-MM-ddTHH:mm') )" `
  --hasta "$(Get-Date -Format 'yyyy-MM-ddTHH:mm')" `
  --step-min 10 `
  --modo forzar

3) Desde enero de 2024 hasta ahora (lo m√°s usado)

python backfill.py `
  --desde "2024-01-01T00:00" `
  --hasta "$(Get-Date -Format 'yyyy-MM-ddTHH:mm')" `
  --step-min 10 `
  --modo forzar

# üíæ Modos de escritura

| Modo            | Descripci√≥n                                                   |
| --------------- | ------------------------------------------------------------- |
| `forzar`        | **UPSERT** ‚Üí actualiza valores si ya existen (recomendado)    |
| `respetar_hora` | Solo inserta si no existe el registro (no pisa datos previos) |


# ‚è±Ô∏è Rendimiento

| Pausa (`REQUEST_SLEEP_SECONDS`) | Velocidad  | Riesgo                       |
| ------------------------------- | ---------- | ---------------------------- |
| `1.0`                           | lento      | muy seguro                   |
| `0.5`                           | estable    | seguro                       |
| `0.25`                          | r√°pido     | recomendado ‚úÖ                |
| `0.10`                          | muy r√°pido | riesgo moderado ‚ö†Ô∏è           |
| `0.0`                           | m√°ximo     | **riesgo alto de bloqueo** ‚ùå |


# üßØ Soluci√≥n de Problemas

| Error                                  | Causa                           | Soluci√≥n                                    |
| -------------------------------------- | ------------------------------- | ------------------------------------------- |
| `ValueError: Invalid isoformat string` | Fecha mal formada               | Usar `"YYYY-MM-DDTHH:MM"`                   |
| 404 en todas las im√°genes              | Falta carpeta de a√±o            | Confirmar que la URL usa `/image/<A√ëO>/...` |
| Muy lento                              | Pausa muy alta / conexi√≥n lenta | Reducir `REQUEST_SLEEP_SECONDS`             |
| Base no se actualiza                   | `DB_FILE` incorrecto            | Verificar `database.py`                     |

# üóÉÔ∏è Esquema de la Tabla

CREATE TABLE IF NOT EXISTS registro_historico (
  fecha_hora_prediccion TEXT PRIMARY KEY,
  octas_predichas INTEGER,
  confianza REAL,
  categoria TEXT,
  descripcion TEXT,
  url_imagen TEXT
);

CREATE UNIQUE INDEX IF NOT EXISTS ux_registro_historico_fecha
  ON registro_historico(fecha_hora_prediccion);

üß™ Comandos r√°pidos (cheatsheet)

# Activar entorno
source .venv/bin/activate         # Linux/macOS
.venv\Scripts\Activate.ps1        # Windows PowerShell

# Actualizar repo y deps
git pull
pip install -r requirements.txt

# Correr backfill (ejemplo)
python backfill.py --desde "2025-01-01T00:00" --hasta "2025-01-07T23:59" --step-min 10 --modo forzar


