# üå•Ô∏è Flujo y Backfill ‚Äî Gu√≠a de Uso

Este documento describe el funcionamiento general del sistema de clasificaci√≥n autom√°tica de nubes y explica c√≥mo ejecutar el proceso de backfill hist√≥rico.

El sistema obtiene im√°genes p√∫blicas del cielo desde un servidor meteorol√≥gico, las procesa con un modelo de IA y almacena los resultados en una base de datos local.

# ‚öôÔ∏è Flujo general

El sistema procesa im√°genes del cielo capturadas peri√≥dicamente por la c√°mara instalada en el observatorio.

Cada imagen pasa por un pipeline automatizado que se ejecuta cada 10 minutos y realiza tres tareas principales:

1. Obtiene la nueva imagen desde la fuente configurada (IMG_URL_BASE).

2. Procesa la imagen con el modelo de clasificaci√≥n de nubes (predict_octas).

3. Almacena el resultado en la base de datos local (registros-octas.db): 


El scheduler (`jobs/scheduler.py`) utiliza APScheduler para ejecutar este flujo de forma continua, garantizando la actualizaci√≥n de datos en tiempo real y alimentando el dashboard anal√≠tico.

# üß© Modos de funcionamiento

El sistema opera en dos modos complementarios:

| Modo                     | Descripci√≥n                                                                                                   | Frecuencia              |
| ------------------------ | ------------------------------------------------------------------------------------------------------------- | ----------------------- |
| **Trigger (autom√°tico)** | Obtiene la √∫ltima imagen disponible cada 10 minutos, la procesa con el modelo y guarda el resultado.          | Permanente              |
| **Backfill (hist√≥rico)** | Recorre un rango de fechas pasado y obtiene las im√°genes correspondientes para generar el registro hist√≥rico. | Eventual / bajo demanda |

# üß† Backfill (backfill.py)

El backfill es un proceso independiente del trigger autom√°tico.

Su finalidad es reconstruir el historial de predicciones sobre un rango de fechas determinado, utilizando la misma l√≥gica del pipeline principal.

# Funcionamiento

El backfill recorre el rango [--desde, --hasta] en pasos horarios.

Dentro de cada hora obtiene 6 im√°genes fijas, correspondientes a los minutos v√°lidos:

`MINUTOS_VALIDOS = [2, 12, 22, 32, 42, 52]`


Para cada intento:

- Construye la URL con `image_url`(`IMG_URL_BASE`, `intento`, `minuto`, `with_year_dir=True`).

- Obtiene la imagen desde el servidor p√∫blico.

- La procesa con predict_octas(resp.content).

- Guarda el resultado con save_prediction(data).

El script muestra al finalizar un resumen con la cantidad total de im√°genes procesadas, duplicadas y fallidas.

## Ejemplo de ejecuci√≥n
``` bash
python -m backfill --desde "2025-01-01T00:00" --hasta "2025-01-31T23:59"
```

Salida esperada:
``` bash
üìä Backfill ‚Üí total=864 | nuevos=830 | duplicados=28 | fallidos=6
```
## Validaciones y tolerancia a fallos

- Si --hasta es menor que --desde, el proceso finaliza con error.

- Los errores de red o im√°genes ausentes se contabilizan como fallidos (miss).

- El proceso es idempotente: no repite registros ya existentes.

- Implementa reintentos autom√°ticos (Retry(total=2)) ante errores HTTP (408, 500, 502, 503, 504).

## üóÇÔ∏è Estructura del servidor de im√°genes

El servidor organiza las im√°genes por a√±o.

El backfill usa el `flag with_year_dir=True` para incluir la carpeta del a√±o correspondiente.

/meteorologia/cielo/image/<A√ëO>/<YYYY>-<MMDDHH><mm>.jpg


**Ejemplo:**

/meteorologia/cielo/image/2025/2025-01010002.jpg


Las ejecuciones del pipeline continuo no requieren esta estructura, ya que operan sobre el a√±o actual (`with_year_dir=False`).

##  Ejemplos de ejecuci√≥n
üîπ **Backfill del a√±o actual (2025)**

En este caso las im√°genes se encuentran en la ra√≠z del servidor (sin carpeta por a√±o).

```bash
python -m backfill --desde "2025-01-01T00:00" --hasta "2025-01-31T23:59"
```

Salida esperada:
```bash
üìä Backfill ‚Üí total=864 | nuevos=830 | duplicados=28 | fallidos=6
```
üîπ **Backfill de un a√±o anterior (2024)**

Para a√±os anteriores las im√°genes est√°n dentro de una carpeta con el a√±o correspondiente, por lo que el script usa `with_year_dir=True` autom√°ticamente.
```bash
python -m backfill --desde "2024-01-01T00:00" --hasta "2024-12-31T23:59"
```

**Ejemplo de ruta accedida:**

http://201.251.63.225/meteorologia/cielo/image/2024/2024-01010002.jpg

üîπ **Backfill desde enero 2024 hasta hoy**

Combina ambos casos: empieza en la carpeta de 2024 y contin√∫a con im√°genes del a√±o actual.
```bash
python -m backfill --desde "2024-01-01T00:00" --hasta "$(date +%Y-%m-%dT%H:%M)"
```
## üßØ Soluci√≥n de problemas

| Situaci√≥n                              | Causa                                      | Soluci√≥n                                               |
| -------------------------------------- | ------------------------------------------ | ------------------------------------------------------ |
| `ValueError: Invalid isoformat string` | Formato de fecha incorrecto                | Usar `"YYYY-MM-DDTHH:MM"`                              |
| 404 en todas las im√°genes              | Carpeta de a√±o omitida                     | Verificar que el backfill incluya `with_year_dir=True` |
| La base no se actualiza                | Im√°genes ya procesadas                     | Es comportamiento esperado                             |
| Muchas fallidas                        | Rango de fechas muy grande o red inestable | Ejecutar por per√≠odos m√°s cortos                       |

## üß™ Atajos y comandos r√°pidos

### Activar entorno virtual
```bash
source .venv/bin/activate          # Linux/macOS
.venv\Scripts\Activate.ps1         # Windows PowerShell
```
### Instalar dependencias
```bash
pip install -r requirements.txt
```

