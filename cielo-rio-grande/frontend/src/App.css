import React, { useState, useEffect } from "react";
import Dashboard from "./pages/Dashboard";

// ‚Äî‚Äî Helpers
const labelCategoria = (c) =>
  ({ SKC: "Despejado", FEW: "Pocas nubes", SCT: "Nubes dispersas", BKN: "Muy nublado", OVC: "Cubierto" }[c] || c || "--");

const confColor = (c) => (c >= 0.7 ? "#16a34a" : c >= 0.5 ? "#eab308" : "#ef4444");

// ‚Äî‚Äî Gauge
function ConfidenceRing({ value = 0, size = 120, stroke = 10 }) {
  const pct = Math.max(0, Math.min(1, value));
  const r = (size - stroke) / 2;
  const C = 2 * Math.PI * r;
  const offset = C * (1 - pct);
  return (
    <div className="relative grid place-items-center" style={{ width: size, height: size }}>
      <svg width={size} height={size}>
        <circle cx={size / 2} cy={size / 2} r={r} fill="none" stroke="rgba(255,255,255,.08)" strokeWidth={stroke} />
        <circle
          cx={size / 2}
          cy={size / 2}
          r={r}
          fill="none"
          stroke={confColor(pct)}
          strokeWidth={stroke}
          strokeLinecap="round"
          strokeDasharray={C}
          strokeDashoffset={offset}
          style={{ transition: "stroke-dashoffset .6s ease" }}
        />
      </svg>
      <div className="absolute text-xl font-extrabold text-sky-50">{Math.round(pct * 100)}%</div>
    </div>
  );
}

export default function App() {
  const [clima, setClima] = useState({});
  const [octas, setOctas] = useState({});
  const [timestamp, setTimestamp] = useState(Date.now());
  const [satImgUrl, setSatImgUrl] = useState(null);
  const [loadingSat, setLoadingSat] = useState(false);

  // √∫nica imagen: desactivamos c√°mara grande
  const SHOW_MAIN_CAMERA = false;

  useEffect(() => {
    const it = setInterval(() => setTimestamp(Date.now()), 600000);
    return () => clearInterval(it);
  }, []);

  useEffect(() => {
    fetch("http://127.0.0.1:8000/clima").then(r => r.json()).then(setClima).catch(() => setClima({}));
    fetch("http://127.0.0.1:8000/octas").then(r => r.json()).then(setOctas).catch(() => setOctas({}));
  }, [timestamp]);

  useEffect(() => () => satImgUrl && URL.revokeObjectURL(satImgUrl), [satImgUrl]);

  const cameraUrl = `http://127.0.0.1:8000/imagen?ts=${timestamp}`;
  const fechaActual = new Date(timestamp).toLocaleDateString("es-AR", { day: "2-digit", month: "2-digit", year: "2-digit" });

  const coberturaPct =
    octas?.octas_predichas != null ? Math.round((Number(octas.octas_predichas) / 8) * 100) : null;
  const confianzaPct = Math.round((Number(octas?.confianza) || 0) * 100);

  const fetchSatellite = async (layer = "clouds_new") => {
    setLoadingSat(true);
    try {
      const res = await fetch(`http://127.0.0.1:8000/satellite?layer=${layer}&ts=${timestamp}`);
      if (!res.ok) throw new Error("No sat image");
      const blob = await res.blob();
      setSatImgUrl(URL.createObjectURL(blob));
    } catch (e) {
      console.error(e);
      setSatImgUrl(null);
    } finally {
      setLoadingSat(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#05060a] to-[#0a0c13] text-white pb-16">
      <h1 className="text-3xl font-bold flex items-center justify-center py-6">
        <span className="mr-2">‚òÅÔ∏è</span> Nubosidad R√≠o Grande
      </h1>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-7xl mx-auto px-4">

        {/* ===== TARJETA CLASIFICACI√ìN (√∫nica imagen) ===== */}
        <div className="lg:col-span-2 rounded-2xl border border-black/30 bg-gradient-to-br from-[#0f141c]/90 to-[#0b0f15]/90 shadow-[0_14px_30px_rgba(0,0,0,.5)] p-5">
          <div className="grid grid-cols-1 lg:grid-cols-[380px_1fr] gap-6 items-center">

            {/* Ventana ‚ÄúGoPro‚Äù */}
            <div className="flex flex-col">
              <div className="relative w-full aspect-[4/3] overflow-hidden rounded-2xl bg-[#0a0f16] shadow-[inset_0_0_0_2px_rgba(255,255,255,.05),inset_0_20px_60px_rgba(255,255,255,.05),inset_0_-30px_60px_rgba(0,0,0,.45)]">
                {/* barra superior */}
                <div className="absolute left-3 right-3 top-3 flex items-center justify-between rounded-xl bg-black/60 px-3 py-1 text-xs font-semibold text-slate-200">
                  <span className="opacity-90 font-extrabold tracking-wide">GoPro</span>
                  <span className="flex items-center gap-2">
                    <span className="h-2 w-2 rounded-full bg-red-500 shadow-[0_0_6px_rgba(239,68,68,.8)] animate-pulse" />
                    <span className="text-red-400">REC</span>
                  </span>
                </div>

                {/* imagen */}
                <img
                  src={cameraUrl}
                  alt="Cielo R√≠o Grande"
                  className="absolute inset-0 h-full w-full object-cover"
                  onError={(e) => (e.currentTarget.style.opacity = 0.2)}
                />

                {/* HUDs inferiores */}
                <div className="absolute left-3 bottom-12 rounded-md bg-black/50 px-2 py-1 text-[11px] font-semibold text-slate-200">
                  ISO 400 | f/2.8 | 1/60s | EV 0.0 | 1080p60
                </div>
                <div className="absolute left-3 bottom-3 rounded-md bg-black/60 px-2 py-1 text-[11px] font-semibold text-slate-200">
                  IAP Camera RIOG 53.8¬∞S 67.8¬∞W
                </div>
                <div className="absolute right-3 bottom-3 rounded-md bg-black/60 px-2 py-1 text-[11px] font-semibold text-slate-200 text-right">
                  FECHA: {fechaActual}<br />
                  TEMP: {clima?.temp ?? "--"} ¬∞C ¬∑ NUB: {octas?.octas_predichas ?? "--"} OCTAS
                </div>
              </div>

              <div className="mt-2 ml-1 text-xs tracking-widest font-extrabold text-slate-400/90">HERD 9</div>
            </div>

            {/* M√©tricas */}
            <div className="flex flex-col gap-3">
              <h3 className="text-2xl font-extrabold leading-tight text-sky-50">
                Modelo de Clasificaci√≥n<br />de Nubes
              </h3>

              <div className="grid grid-cols-2 md:grid-cols-3 items-center gap-x-6 gap-y-3">
                <div className="flex flex-col gap-1">
                  <span className="text-[12px] tracking-widest uppercase text-slate-400">Cobertura</span>
                  <span className="text-3xl font-extrabold">{coberturaPct != null ? `${coberturaPct}%` : "--"}</span>
                </div>

                <div className="col-span-1 md:col-span-2 flex flex-col gap-1">
                  <span className="text-[12px] tracking-widest uppercase text-slate-400">Tipo dominante</span>
                  <span className="text-3xl font-extrabold">
                    {octas?.categoria || "--"} ‚Äî {labelCategoria(octas?.categoria)}
                  </span>
                </div>

                <div className="flex flex-col gap-1">
                  <span className="text-[12px] tracking-widest uppercase text-slate-400">Oktas</span>
                  <span className="text-3xl font-extrabold">{octas?.octas_predichas ?? "--"}</span>
                </div>

                <div className="col-span-1 md:col-span-2 flex items-center gap-6">
                  <ConfidenceRing value={Number(octas?.confianza || 0)} size={130} stroke={12} />
                  <div className="text-xs tracking-widest uppercase text-slate-400">
                    Confianza <span className="font-semibold text-slate-200">({confianzaPct}%)</span>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        {/* ===== Clima detallado (abajo, ancho completo) ===== */}
        <div className="lg:col-span-2 rounded-2xl border border-cyan-700/40 bg-slate-800/60 backdrop-blur p-5 shadow">
          <h2 className="text-xl font-semibold text-cyan-300 mb-3">Clima Detallado</h2>
          <div className="grid grid-cols-2 gap-y-1 text-slate-100 text-sm">
            <div>Temperatura:</div><div className="text-right">{clima.temp ?? "--"} ¬∞C</div>
            <div>Sensaci√≥n t√©rmica:</div><div className="text-right">{clima.feels_like ?? "--"} ¬∞C</div>
            <div>Humedad:</div><div className="text-right">{clima.humedad ?? "--"}%</div>
            <div>Viento:</div><div className="text-right">{clima.viento ?? "--"} m/s</div>
            <div>Direcci√≥n del viento:</div><div className="text-right">{clima.viento_dir ?? "--"}¬∞</div>
            <div>Presi√≥n atmosf√©rica:</div><div className="text-right">{clima.presion ?? "--"} hPa</div>
          </div>
        </div>

        {/* ===== Sat√©lite / Radar (abajo, ancho completo) ===== */}
        <div className="lg:col-span-2 rounded-2xl bg-gradient-to-br from-[#0c0f14]/90 to-[#131821]/90 p-5 shadow-[0_10px_28px_rgba(0,0,0,.65)]">
          <h3 className="text-lg font-semibold text-cyan-300 mb-3">üõ∞Ô∏è Sat√©lite / Radar</h3>

          <div className="relative rounded-xl overflow-hidden border border-cyan-300/10 bg-[radial-gradient(1200px_400px_at_10%_0,rgba(0,255,255,.08),transparent_40%)]">
            {satImgUrl ? (
              <img src={satImgUrl} alt="Radar" className="h-56 w-full object-cover" />
            ) : (
              <div className="h-56 w-full grid place-items-center text-[11px] tracking-[.2em] text-cyan-100/80">
                RADAR PREVIEW ‚Äî toc√° ‚ÄúVer Nubes‚Äù
              </div>
            )}
            <div className="absolute left-2 top-2 rounded-md border border-white/10 bg-black/50 px-2 py-1 text-[11px] tracking-widest text-cyan-100 backdrop-blur">
              RADAR PREVIEW
            </div>
          </div>

          <div className="mt-3 flex justify-center gap-3">
            <button
              className="rounded-lg bg-gradient-to-br from-sky-600 to-sky-700 px-4 py-2 font-bold shadow hover:scale-[1.02] transition disabled:opacity-60"
              onClick={() => fetchSatellite("clouds_new")}
              disabled={loadingSat}
            >
              {loadingSat ? "Cargando..." : "Ver Nubes"}
            </button>
          </div>

          <p className="mt-2 text-center text-sm text-slate-300/80 italic">
            Presion√° ‚ÄúVer Nubes‚Äù para actualizar la imagen satelital.
          </p>
        </div>

      </div>

      {/* ===== Dashboard anal√≠tico ===== */}
      <div className="max-w-7xl mx-auto px-6 mt-16">
        <h2 className="text-2xl font-semibold text-center text-cyan-400 mb-6 tracking-wide">
          <span className="mr-2" role="img" aria-label="chart">üìà</span>
          Anal√≠ticas de Nubosidad ‚Äì Evoluci√≥n y Comportamiento
        </h2>
        <Dashboard />
      </div>
    </div>
  );
}
